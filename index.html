<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TECH4ZERO – Educational Designs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    body { margin:0; font-family:'Open Sans', Arial, sans-serif; background-color:#1E2F3F; color:#ffffff; }

    header { padding:40px 20px; text-align:center; background:linear-gradient(180deg, #1E2F3F, #16222D); }
    header h1 { font-family:'Playfair Display', serif; font-size:48px; margin:0; }
    header p { color:#D6A21C; letter-spacing:2px; margin-top:10px; font-size:14px; }

    nav { display:flex; justify-content:center; gap:15px; padding:15px; background-color:#16222D; flex-wrap:wrap; align-items:center; }
    nav a { background-color:#1E2F3F; color:white; padding:8px 18px; border-radius:20px; text-decoration:none; font-size:14px; font-weight:600; }
    nav a:hover { background-color:#D6A21C; color:#16222D; }

    /* Buttons */
    .btnPrimary {
      padding:10px 16px;
      font-weight:700;
      border-radius:6px;
      border:1px solid #D6A21C;
      cursor:pointer;
      background:#D6A21C;
      color:#16222D;
    }
    .btnSecondary {
      padding:10px 16px;
      font-weight:600;
      border-radius:6px;
      border:1px solid #D6A21C;
      background:transparent;
      color:#D6A21C;
      cursor:pointer;
    }
    .btnPrimary:disabled, .btnSecondary:disabled {
      opacity:0.45;
      cursor:not-allowed;
    }

    /* Session bar */
    .sessionBar {
      display:flex;
      justify-content:center;
      align-items:center;
      gap:12px;
      padding:10px 15px;
      background:#0f1d27;
      border-bottom:1px solid #365468;
      flex-wrap:wrap;
    }
    .sessionBadge {
      padding:6px 12px;
      border-radius:999px;
      font-size:13px;
      font-weight:700;
      border:1px solid #365468;
      background:#1E2F3F;
    }
    .badgeOk { color:#b9ffcf; }
    .badgeNo { color:#ffdca8; }

    section { display:none; padding:50px 20px; max-width:1000px; margin:auto; }
    section.active { display:block; }

    h2 { font-family:'Playfair Display', serif; color:#D6A21C; font-size:32px; margin-top:0; }

    .card { background-color:#243A4B; padding:25px; border-radius:8px; margin-top:25px; }

    footer { text-align:center; padding:30px; font-size:13px; background-color:#16222D; margin-top:50px; }

    /* Compact panel + stacked inputs */
    .formPanel {
      margin-top: 18px;
      background: #1E2F3F;
      padding: 16px;
      border-radius: 8px;
      max-width: 520px;
      border: 1px solid #365468;
    }
    .fieldBlock { margin-bottom: 14px; }
    .fieldLabel { font-weight:600; display:inline-block; margin-bottom:6px; }
    .textInput {
      width:100%;
      max-width:380px;
      padding:8px;
      border-radius:6px;
      border:1px solid #365468;
      background:#0f1d27;
      color:#ffffff;
      outline:none;
    }
    .textInput::placeholder { color:#a9c0d3; }

    .statusMsg { margin-top:12px; font-weight:600; min-height:18px; }
    .statusOk { color:#b9ffcf; }
    .statusWarn { color:#ffdca8; }
    .statusErr { color:#ffb4b4; }

    /* Modal */
    .modalOverlay {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.65);
      z-index:9999;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .modalBox {
      width:min(620px, 95vw);
      background:#16222D;
      border:1px solid #365468;
      border-radius:12px;
      padding:18px;
      box-shadow:0 20px 60px rgba(0,0,0,0.35);
    }
    .modalHeader {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .modalTitle {
      font-family:'Playfair Display', serif;
      color:#D6A21C;
      font-size:22px;
      margin:0;
    }
    .modalClose {
      background:transparent;
      border:1px solid #365468;
      color:#fff;
      border-radius:8px;
      padding:6px 10px;
      cursor:pointer;
      font-weight:700;
    }

    .navAccess { margin-left: 40px; }

.video-container {
  position: relative;
  width: 65%;           /* <-- 80% = 20% más pequeño */
  padding-top: 45%;     /* mantiene proporción aproximada */
  margin: 16px auto;    /* centra el video */
  border-radius: 12px;
  overflow: hidden;
}

.video-container iframe {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
}
    /* Alinear texto con el ancho del video (ahora tu video es 65%) */
.programa-content{
  width: 65%;
  margin: 0 auto;
}

/* Opcional: que el texto/bullets no queden pegados al borde */
.programa-content p,
.programa-content ul,
.programa-content .nota{
  margin-left: 0;
  margin-right: 0;
}

/* Celular: texto y video a 100% */
@media (max-width: 768px){
  .programa-content{
    width: 100%;
  }

  .video-container{
    width: 100%;
    padding-top: 56.25%; /* 16:9 en mobile */
  }
}


    /* Bullets Programa: números en amarillo (igual que títulos) */
.bullets-programa .num{
  color:#D6A21C;
  font-weight:800;          /* opcional, para que destaque */
  font-size: calc(1em + 1px); /* +1px aprox */
}

    .highlight {
  color:#D6A21C;
  font-weight:700;
}
    
  </style>

  <script>
    function showTab(tabId) {
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      if (tabId === 'datos') window.loadDatosIfNeeded?.();
    }
  </script>
</head>

<body>

<header>
  <h1>TECH4ZERO</h1>
  <p>EDUCATION+IA</p>
</header>

<nav>
  <a href="#" onclick="showTab('home'); return false;">INICIO</a>
  <a href="#" onclick="showTab('programa'); return false;">PROGRAMA</a>
  <a href="#" onclick="showTab('encuesta'); return false;">ENCUESTA</a>
  <a href="#" onclick="showTab('datos'); return false;">DATOS</a>
  <a href="#" onclick="showTab('resultados'); return false;">RESULTADOS</a>
  <a href="#" onclick="showTab('equipo'); return false;">EQUIPO</a>
  <a href="#" onclick="showTab('contacto'); return false;">CONTACTO</a>

  <button id="btnAccesoUsuarios" class="btnPrimary navAccess" type="button">ACCESO USUARIOS</button>
</nav>

<!-- BARRA GLOBAL DE SESIÓN -->
<div class="sessionBar">
  <span id="sessionBadge" class="sessionBadge badgeNo">No autenticado</span>
</div>

<section id="home" class="active">
  <h2>Bienvenidos</h2>

  <div class="card">
    <p>
<strong>TECH4ZERO</strong> diseña soluciones educativas basadas en evidencia científica para fortalecer la convivencia escolar y el bienestar socioemocional.
<br><br>
Aplicamos una <span class="highlight">encuesta online</span> y analizamos los resultados con <span class="highlight">estadística avanzada e inteligencia artificial</span>, evaluando al 
      100% de tu comunidad escolar en menos de 48 horas. Nuestra evaluación se alinea con los estándares <strong>ESSA</strong> y los marcos de la <strong>UNESCO</strong>.
<br><br>
Identificamos zonas de riesgo físico y digital —ciberacoso, liderazgo docente, clima en cada salón de clases, áreas sin supervisión— y 
te entregamos un perfil completo de tu escuela, junto con un plan de intervención listo para implementar.
    </p>
  </div>

  <div class="card" style="margin-top:30px; text-align:center;">
    <iframe width="560" height="315"
      src="https://www.youtube.com/embed/iBO4YijRYbs"
      title="Programa ZERO"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen>
    </iframe>
  </div>

  <div style="margin-top:30px; text-align:center;">
    <img src="zero.png" alt="Logo ZERO" style="max-width:220px;" />
  </div>
</section>

<section id="programa">
  <h2>Programa Antibullying TECH4ZERO</h2>

  <div class="card">
<div class="programa-content">
  <p>
    <br>
    El programa ZERO tiene gran impacto previniendo y eliminando la violencia escolar.
    Además de mejorar el ambiente socio-emocional de todo el establecimiento.
  </p>
<br>
  <ul class="bullets-programa">
    <li><span class="num">300+</span> escuelas implementadas en: <br>México, Chile, Costa Rica, República Dominicana, EE.UU.</li>
    <li><span class="num">37%</span> reducción promedio en incidentes reportados a los 90 días</li>
    <li><span class="num">4.2x</span> más intervenciones preventivas vs. reactivas</li>
    <li><span class="num">92%</span> de docentes reportan mayor confianza para identificar señales tempranas</li>
  </ul>

  <!-- Si quieres, puedes dejar tus <br> aquí -->
  <br><br>
</div>


    <!-- VIDEO1 -->
<div class="video-container">
  <iframe
    src="https://www.youtube.com/embed/zw1zTrZn2ic"
    title="Video 1"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen>
  </iframe>
</div>

<!-- VIDEO2 -->
<div class="video-container">
  <iframe
    src="https://www.youtube.com/embed/rC_xEqFqZ_s?start=1"
    title="Video TECH4ZERO"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen>
  </iframe>
</div>

<!-- VIDEO3 -->
<div class="video-container">
  <iframe
    src="https://www.youtube.com/embed/vLFFojLhCZs?start=1"
    title="Video TECH4ZERO"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen>
  </iframe>
</div>


    
    <p class="nota">
      Datos consolidados de cohortes 2023-2025. Resultados varían según contexto institucional.
    </p>
  </div>
</section>

<section id="encuesta">
  <h2>Encuesta Escolar</h2>

  <div class="card">
    <p>
      Para ingresar a la encuesta y solicitar análisis, debe estar autenticado desde <b>ACCESO USUARIOS</b>.
    </p>

    <div id="encuestaOK" class="formPanel" style="display:block; max-width:520px;">
      <p id="schoolWelcome" style="margin:0 0 12px 0;">Estado de sesión: No autenticado.</p>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button id="btnIngresarEncuesta" class="btnPrimary" type="button">Ingresar a la encuesta</button>
        <button id="btnSolicitarAnalisis" class="btnSecondary" type="button">Solicitar analisis de la encuesta</button>
      </div>

      <div id="encuestaNeedLogin" class="statusMsg statusWarn" style="display:none;">
        Debe iniciar sesión con <b>ACCESO USUARIOS</b> para continuar.
      </div>
    </div>

    <div id="analisisWarnPanel" class="formPanel" style="display:none; max-width:520px; border:1px solid #D6A21C;">
      <div style="font-weight:700; margin-bottom:10px;">Advertencia</div>
      <div style="margin-bottom:14px;">
        El sistema realizara un analisis estadistico detallado del ambiente escolar con las encuestas introducidas en el sistema para su escuela, pero no podra adicionar nuevas encuestas.
        <br /><br />
        Desea continuar?
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="btnAnalisisContinuar" class="btnPrimary" type="button">Continuar</button>
        <button id="btnAnalisisCancelar" class="btnSecondary" type="button">Cancelar</button>
      </div>
    </div>

    <div id="surveyBox" class="formPanel" style="display:none; margin-top:18px;">
      <div id="qTitle" style="font-weight:700; margin-bottom:10px;"></div>
      <div id="qText" style="margin-bottom:12px;"></div>
      <div id="qOptions"></div>

      <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
        <button id="btnQPrev" class="btnSecondary" type="button">Anterior</button>
        <button id="btnQNext" class="btnPrimary" type="button">Siguiente</button>
      </div>

      <div id="surveyMsg" class="statusMsg statusWarn"></div>
    </div>

  </div>
</section>

<section id="resultados">
  <h2>Resultados Encuesta</h2>

  <div class="card">
    <p>
      Para ver resultados debe estar autenticado desde <b>ACCESO USUARIOS</b>.
    </p>

    <div class="formPanel" style="display:block; max-width:520px;">
      <div id="resultadosNeedLogin" class="statusMsg statusWarn" style="display:none;">
        Debe iniciar sesión con <b>ACCESO USUARIOS</b> para mostrar resultados.
      </div>

      <div style="margin-top:10px;">
        <button id="btnMostrarResultados" class="btnPrimary" type="button">
          Mostrar resultados encuesta
        </button>
      </div>
    </div>

  </div>
</section>

<section id="datos">
  <h2>Datos</h2>

  <div class="card">
    <p>
      Esta sección lee datos desde Supabase (tabla <b>encargado_escolar</b>) para verificar conexión.
    </p>

    <div class="formPanel">
      <div class="fieldBlock">
        <label class="fieldLabel" for="d_nombre">Nombre</label><br />
        <input id="d_nombre" class="textInput" type="text" placeholder="Nombre" readonly />
      </div>

      <div class="fieldBlock">
        <label class="fieldLabel" for="d_ap_paterno">Apellido Paterno</label><br />
        <input id="d_ap_paterno" class="textInput" type="text" placeholder="Apellido Paterno" readonly />
      </div>

      <div class="fieldBlock">
        <label class="fieldLabel" for="d_ap_materno">Apellido Materno</label><br />
        <input id="d_ap_materno" class="textInput" type="text" placeholder="Apellido Materno" readonly />
      </div>

      <div class="fieldBlock">
        <label class="fieldLabel" for="d_establecimiento">Establecimiento</label><br />
        <input id="d_establecimiento" class="textInput" type="text" placeholder="Establecimiento" readonly />
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;">
        <button id="btnPrev" class="btnSecondary" type="button">Retroceder</button>
        <button id="btnNext" class="btnPrimary" type="button">Avanzar</button>
      </div>

      <div id="datosStatus" class="statusMsg statusWarn"></div>
    </div>
  </div>
</section>

<section id="equipo">
  <h2>Nuestro Equipo</h2>

  <div class="card">
    <p>
      Equipo interdisciplinario de especialistas en educación, psicología y tecnología
      comprometidos con comunidades escolares seguras.
    </p>
  </div>

  <div class="card" style="margin-top:18px;">
    <div style="
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:16px;
    ">
      <!-- Rodolfo -->
      <div style="background:#1E2F3F; border:1px solid #365468; border-radius:10px; padding:14px;">
        <img
          src="Rodyfoto77.png"
          alt="Foto Integrante 1"
          style="width:100%; aspect-ratio: 4/3; object-fit:cover; border-radius:10px; border:1px solid #365468; margin-bottom:10px;"
        />
        <div style="font-weight:800; font-size:16px; margin-bottom:6px;">Rodolfo Lino</div>
        <div style="color:#D6A21C; font-weight:700; font-size:13px; margin-bottom:8px;">
          Master en Psicologia de la Educacion - Profesor de Historia y Geografía.
        </div>
        <p style="margin:0; color:#d9e6f2; font-size:14px; line-height:1.4;">
          Rodolfo enseña habilidades socioemocionales en el mundo educativo. 
          Ha sido invitado por la ciudad de Neuss, en Alemania, para liderar el programa Die Welt Erziehung Und Die Neuerung 
          (Educación e Innovación Mundial) y ha implementado exitosamente el programa Zero en Chile, México, Costa Rica, República Dominicana y Estados Unidos.

        </p>
      </div>

      <!-- Marcos -->
      <div style="background:#1E2F3F; border:1px solid #365468; border-radius:10px; padding:14px;">
        <img
          src="Marcos.png"
          alt="Foto Integrante 2"
          style="width:100%; aspect-ratio: 4/3; object-fit:cover; border-radius:10px; border:1px solid #365468; margin-bottom:10px;"
        />
        <div style="font-weight:800; font-size:16px; margin-bottom:6px;">Marcos Miranda</div>
        <div style="color:#D6A21C; font-weight:700; font-size:13px; margin-bottom:8px;">
          Doctor en Educacion
        </div>
        <p style="margin:0; color:#d9e6f2; font-size:14px; line-height:1.4;">
          Marcos convierte ambientes escolares desafiantes en espacios de pertenencia, respeto y alto rendimiento. Su enfoque único combina ciencia, equidad y liderazgo para generar cambios reales y 
          duraderos en la cultura escolar. Su idea es lograr instituciones que florecen y donde los estudiantes alcanzan su verdadero potencial.
        </p>
      </div>

      <!-- Lester -->
      <div style="background:#1E2F3F; border:1px solid #365468; border-radius:10px; padding:14px;">
        <img
          src="Lesterfoto55.png"
          alt="Foto Integrante 3"
          style="width:100%; aspect-ratio: 4/3; object-fit:cover; border-radius:10px; border:1px solid #365468; margin-bottom:10px;"
        />
        <div style="font-weight:800; font-size:16px; margin-bottom:6px;">Lester Lino</div>
        <div style="color:#D6A21C; font-weight:700; font-size:13px; margin-bottom:8px;">
          Master en Ingenieria en Computacion
        </div>
        <p style="margin:0; color:#d9e6f2; font-size:14px; line-height:1.4;">
          Consultor senior en datos, inteligencia artificial y tecnología, modernizando y asegurando sistemas de 
          misión crítica en los sectores de educación, salud y minería.Experto en interacción humano-tecnologíca en entornos de alto riesgo.
        </p>
      </div>
    </div>

    <!-- Responsive (móvil) -->
    <div style="margin-top:12px; color:#a9c0d3; font-size:12px;">
      <script>
        // No es necesario, pero si quieres: puedes eliminar este script.
      </script>
    </div>
  </div>
</section>

<section id="contacto">
  <h2>Contáctenos</h2>

  <div class="card">
    <p>También puede escribirnos usando el formulario:</p>

    <div class="formPanel" style="max-width:640px;">
      <div class="fieldBlock">
        <label class="fieldLabel" for="c_nombre">Nombre</label><br />
        <input id="c_nombre" class="textInput" type="text" placeholder="Tu nombre" />
      </div>

      <div class="fieldBlock">
        <label class="fieldLabel" for="c_email">Email</label><br />
        <input id="c_email" class="textInput" type="email" placeholder="tu@email.com" />
      </div>

      <div class="fieldBlock">
        <label class="fieldLabel" for="c_asunto">Asunto</label><br />
        <input id="c_asunto" class="textInput" type="text" placeholder="Asunto" />
      </div>

      <div class="fieldBlock">
        <label class="fieldLabel" for="c_mensaje">Mensaje</label><br />
        <textarea id="c_mensaje" class="textInput" rows="6" placeholder="Escribe tu mensaje..."></textarea>
      </div>

      <!-- Honeypot anti-bots (debe quedar vacío) -->
      <input id="c_company" type="text" style="display:none" tabindex="-1" autocomplete="off" />

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="btnEnviarContacto" class="btnPrimary" type="button">Enviar</button>
        <button id="btnLimpiarContacto" class="btnSecondary" type="button">Limpiar</button>
      </div>

      <div id="contactoMsg" class="statusMsg statusWarn"></div>

      <p style="margin-top:12px; opacity:0.85;">
        Email directo: <b>contacto@tech4zero.org</b>
      </p>
    </div>
  </div>
</section>

<footer>
  © 2025 TECH4ZERO – EDUCATION+AI
</footer>

<!-- MODAL GLOBAL: ACCESO USUARIOS -->
<div id="globalModal" class="modalOverlay">
  <div class="modalBox">
    <div class="modalHeader">
      <h3 class="modalTitle">Acceso Usuarios</h3>
      <button id="modalClose" class="modalClose" type="button">X</button>
    </div>

    <div id="modalSessionOn" style="display:none;">
      <div class="statusMsg statusOk" id="modalSessionText"></div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button id="btnCerrarSesion" class="btnSecondary" type="button">Cerrar sesión</button>
        <button id="btnCerrarModal1" class="btnPrimary" type="button">Cerrar</button>
      </div>
    </div>

    <div id="modalSessionOff" style="display:none;">
      <div class="formPanel" style="margin-top:10px; max-width:100%;">
        <div class="fieldBlock">
          <label for="globalUser" class="fieldLabel">Usuario</label><br />
          <input id="globalUser" class="textInput" type="text" placeholder="Usuario" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" />
        </div>

        <div class="fieldBlock">
          <label for="globalPass" class="fieldLabel">Contraseña</label><br />
          <input id="globalPass" class="textInput" type="password" placeholder="Contraseña" autocomplete="new-password" />
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="btnDoLogin" class="btnPrimary" type="button">Entrar</button>
          <button id="btnCerrarModal2" class="btnSecondary" type="button">Cancelar</button>
        </div>

        <div id="globalLoginMsg" class="statusMsg statusErr"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // === DEBUG: mostrar errores JS sin consola ===
  window.onerror = function (msg, src, line, col) {
    alert(`JS ERROR: ${msg}\n${src}:${line}:${col}`);
  };
  window.onunhandledrejection = function (e) {
    const reason = e?.reason;
    const msg = (reason && (reason.message || String(reason))) || 'Unhandled promise rejection';
    alert('PROMISE ERROR: ' + msg);
  };

  // =========================
  // SESSION STATE GLOBAL
  // =========================
  window.sessionState = { ok:false, school_id:null, school_name:null };

  const sessionBadge = document.getElementById('sessionBadge');
  const btnAccesoUsuarios = document.getElementById('btnAccesoUsuarios');

  const encuestaNeedLogin = document.getElementById('encuestaNeedLogin');
  const resultadosNeedLogin = document.getElementById('resultadosNeedLogin');

  const encuestaOK = document.getElementById('encuestaOK');

  const schoolWelcome = document.getElementById('schoolWelcome');
  const btnIngresarEncuesta = document.getElementById('btnIngresarEncuesta');
  const btnSolicitarAnalisis = document.getElementById('btnSolicitarAnalisis');

  const analisisWarnPanel = document.getElementById('analisisWarnPanel');
  const btnAnalisisContinuar = document.getElementById('btnAnalisisContinuar');
  const btnAnalisisCancelar = document.getElementById('btnAnalisisCancelar');

  const surveyBox = document.getElementById('surveyBox');
  const btnMostrarResultados = document.getElementById('btnMostrarResultados');

  async function refreshSession() {
    try {
      const res = await fetch('/api/me', { credentials:'include' });
      const data = await res.json().catch(() => ({}));
      window.sessionState = {
        ok: !!data?.ok,
        school_id: data?.school_id || null,
        school_name: data?.school_name || null
      };
    } catch (e) {
      window.sessionState = { ok:false, school_id:null, school_name:null };
    }
    applySessionToUI();
  }

  function applySessionToUI() {
    const ok = window.sessionState.ok;
    const schoolName = window.sessionState.school_name || '';

    if (ok) {
      sessionBadge.textContent = `Autenticado: ${schoolName || 'OK'}`;
      sessionBadge.classList.remove('badgeNo');
      sessionBadge.classList.add('badgeOk');
    } else {
      sessionBadge.textContent = 'No autenticado';
      sessionBadge.classList.remove('badgeOk');
      sessionBadge.classList.add('badgeNo');
    }

    if (schoolWelcome) {
      schoolWelcome.textContent = ok
        ? `Estado de sesión: Autenticado. Escuela: ${schoolName}`.trim()
        : 'Estado de sesión: No autenticado.';
    }

    if (btnIngresarEncuesta) btnIngresarEncuesta.disabled = !ok;
    if (btnSolicitarAnalisis) btnSolicitarAnalisis.disabled = !ok;
    if (btnMostrarResultados) btnMostrarResultados.disabled = !ok;

    if (encuestaNeedLogin) encuestaNeedLogin.style.display = ok ? 'none' : 'block';
    if (resultadosNeedLogin) resultadosNeedLogin.style.display = ok ? 'none' : 'block';

    if (!ok) {
      if (analisisWarnPanel) analisisWarnPanel.style.display = 'none';
      if (surveyBox) surveyBox.style.display = 'none';
    }

    if (ok && surveyBox && surveyBox.style.display === 'none') {
      if (btnIngresarEncuesta) btnIngresarEncuesta.disabled = false;
      if (btnSolicitarAnalisis) btnSolicitarAnalisis.disabled = false;
      if (encuestaOK) {
        encuestaOK.style.pointerEvents = 'auto';
        encuestaOK.style.opacity = '';
      }
    }
  }

  // =========================
  // MODAL LOGIN / LOGOUT
  // =========================
  const globalModal = document.getElementById('globalModal');
  const modalClose = document.getElementById('modalClose');

  const modalSessionOn = document.getElementById('modalSessionOn');
  const modalSessionOff = document.getElementById('modalSessionOff');
  const modalSessionText = document.getElementById('modalSessionText');

  const btnCerrarSesion = document.getElementById('btnCerrarSesion');
  const btnCerrarModal1 = document.getElementById('btnCerrarModal1');
  const btnCerrarModal2 = document.getElementById('btnCerrarModal2');

  const globalUser = document.getElementById('globalUser');
  const globalPass = document.getElementById('globalPass');
  const btnDoLogin = document.getElementById('btnDoLogin');
  const globalLoginMsg = document.getElementById('globalLoginMsg');

  function openModal() {
    const ok = window.sessionState.ok;
    if (globalLoginMsg) globalLoginMsg.textContent = '';
    if (globalUser) globalUser.value = '';
    if (globalPass) globalPass.value = '';

    if (ok) {
      modalSessionOff.style.display = 'none';
      modalSessionOn.style.display = 'block';
      modalSessionText.textContent = `Sesión activa. Escuela: ${window.sessionState.school_name || ''}`.trim();
    } else {
      modalSessionOn.style.display = 'none';
      modalSessionOff.style.display = 'block';
      setTimeout(() => globalUser?.focus(), 50);
    }

    globalModal.style.display = 'flex';
  }

  function closeModal() {
    globalModal.style.display = 'none';
  }

  // ✅ Asegurar que el botón funcione siempre
  btnAccesoUsuarios?.addEventListener('click', openModal);
  modalClose?.addEventListener('click', closeModal);
  btnCerrarModal1?.addEventListener('click', closeModal);
  btnCerrarModal2?.addEventListener('click', closeModal);

  globalModal?.addEventListener('click', (e) => {
    if (e.target === globalModal) closeModal();
  });

  btnDoLogin?.addEventListener('click', async () => {
    const u = globalUser?.value?.trim() || '';
    const p = globalPass?.value?.trim() || '';

    if (!u || !p) {
      globalLoginMsg.textContent = 'Por favor ingrese usuario y contraseña.';
      return;
    }

    try {
      globalLoginMsg.textContent = 'Validando...';

      const res = await fetch('/api/login', {
        method:'POST',
        credentials:'include',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ username:u, password:p })
      });

      const raw = await res.text();
      let data = {};
      try { data = raw ? JSON.parse(raw) : {}; } catch { data = { raw }; }

      if (!res.ok || !data.ok) {
        globalLoginMsg.textContent = `Login falló (HTTP ${res.status}): ${data.error || data.raw || 'sin detalle'}`;
        return;
      }

      globalLoginMsg.textContent = '';
      closeModal();
      await refreshSession();
    } catch (e) {
      globalLoginMsg.textContent = 'Error de conexión.';
    }
  });

  btnCerrarSesion?.addEventListener('click', async () => {
    await fetch('/api/logout', { method:'POST', credentials:'include' }).catch(() => {});
    closeModal();
    await refreshSession();
  });

  // =========================
  // ACCIONES ENCUESTA
  // =========================
  btnIngresarEncuesta?.addEventListener('click', async () => {
    if (!window.sessionState.ok) { openModal(); return; }
    if (analisisWarnPanel) analisisWarnPanel.style.display = 'none';
    await showSurveyUI();
  });

  btnSolicitarAnalisis?.addEventListener('click', () => {
    if (!window.sessionState.ok) { openModal(); return; }
    if (analisisWarnPanel) analisisWarnPanel.style.display = 'block';
  });

  btnAnalisisCancelar?.addEventListener('click', async () => {
    if (analisisWarnPanel) analisisWarnPanel.style.display = 'none';
  });

  btnAnalisisContinuar?.addEventListener('click', async () => {
    try {
      const meRes = await fetch('/api/me', { credentials: 'include' });
      const meData = await meRes.json().catch(() => ({}));

      if (!meRes.ok || !meData.ok) {
        openModal();
        return;
      }

      const res = await fetch('/api/request-analysis', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' }
      });

      const raw = await res.text();
      let data = {};
      try { data = raw ? JSON.parse(raw) : {}; } catch { data = { raw }; }

      if (!res.ok || !data.ok) {
        alert(
          'No se pudo solicitar el análisis (HTTP ' + res.status + '):\n' +
          (data.error || data.raw || 'sin detalle')
        );
        return;
      }

      alert('Solicitud enviada.\n\nEl sistema realizará el análisis de la encuesta.\nPuedes ir a la pestaña "RESULTADOS" para ver el análisis.');
      if (analisisWarnPanel) analisisWarnPanel.style.display = 'none';
    } catch (e) {
      alert('Error de conexión al solicitar el análisis.\n\n' + (e?.message || String(e)));
    }
  });

  btnMostrarResultados?.addEventListener('click', async () => {
    if (!window.sessionState.ok) { openModal(); return; }

    const latestRes = await fetch('/api/results-latest-analysis', { credentials:'include' });
    const latest = await latestRes.json().catch(() => ({}));

    if (!latestRes.ok || !latest.ok) {
      alert(`No se pudo obtener el último análisis: ${latest.error || 'sin detalle'}`);
      return;
    }

    if (!latest.analysis_dt) {
      alert('Aún no hay un análisis solicitado para esta escuela.');
      return;
    }

    const baseUrl = 'https://sreamlitzero-shmskdwqqlhrt4yc8soy5o.streamlit.app/';
    const url = `${baseUrl}?school_id=${encodeURIComponent(latest.school_id)}&analysis_dt=${encodeURIComponent(latest.analysis_dt)}`;
    window.location.href = url;
  });

  // =========================
  // DATOS: Supabase REST read (sin cambios)
  // =========================
  const SUPABASE_URL = "https://dthynoikkbmgulbrueya.supabase.co";
  const SUPABASE_ANON_KEY = "REEMPLAZA_AQUI_SI_CAMBIA";

  let datosIndex = 0;
  let datosLoadedOnce = false;

  const elNombre = document.getElementById('d_nombre');
  const elApPaterno = document.getElementById('d_ap_paterno');
  const elApMaterno = document.getElementById('d_ap_materno');
  const elEst = document.getElementById('d_establecimiento');
  const elStatus = document.getElementById('datosStatus');

  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');

  function setStatus(text, type) {
    elStatus.textContent = text || '';
    elStatus.classList.remove('statusOk', 'statusWarn', 'statusErr');
    elStatus.classList.add(type || 'statusWarn');
  }

  function fillFields(row) {
    elNombre.value = row?.first_name ?? '';
    elApPaterno.value = row?.pat_last_name ?? '';
    elApMaterno.value = row?.mat_last_name ?? '';
    elEst.value = row?.school_id ?? '';
  }

  async function fetchOneRow(offset) {
    const url =
      `${SUPABASE_URL}/rest/v1/encargado_escolar` +
      `?select=first_name,pat_last_name,mat_last_name,school_id` +
      `&limit=1&offset=${offset}`;

    const res = await fetch(url, {
      headers: {
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": "Bearer " + SUPABASE_ANON_KEY,
        "Accept": "application/json"
      }
    });

    const text = await res.text();
    let json;
    try { json = text ? JSON.parse(text) : null; } catch { json = null; }

    return { ok: res.ok, status: res.status, json };
  }

  async function loadCurrent() {
    setStatus("Cargando datos...", "statusWarn");

    try {
      const result = await fetchOneRow(datosIndex);

      if (!result.ok) {
        setStatus(`No se pudo leer encargado_escolar (HTTP ${result.status ?? "?"}).`, "statusErr");
        fillFields(null);
        return;
      }

      const arr = Array.isArray(result.json) ? result.json : [];
      if (arr.length === 0) {
        if (datosIndex === 0) {
          setStatus("La tabla encargado_escolar está vacía (no hay registros).", "statusWarn");
        } else {
          setStatus("No hay más registros. Retrocede para ver anteriores.", "statusWarn");
          datosIndex = Math.max(0, datosIndex - 1);
        }
        fillFields(null);
        return;
      }

      fillFields(arr[0]);
      setStatus(`Mostrando registro #${datosIndex + 1}`, "statusOk");
    } catch (e) {
      setStatus("Error de conexión con Supabase.", "statusErr");
      fillFields(null);
    }
  }

  btnPrev?.addEventListener('click', async () => {
    datosIndex = Math.max(0, datosIndex - 1);
    await loadCurrent();
  });

  btnNext?.addEventListener('click', async () => {
    datosIndex = datosIndex + 1;
    await loadCurrent();
  });

  window.loadDatosIfNeeded = async () => {
    if (datosLoadedOnce) return;
    datosLoadedOnce = true;
    datosIndex = 0;
    await loadCurrent();
  };

  // ================================
  // ENCUESTA: FIX PRINCIPAL (UUIDs + external_id)
  // ================================
  const SURVEY_UUID = "d43cddec-0693-4d03-a6f4-31b73e44b31f"; // tu survey real en supabase
  const SURVEY_CODE = "SURVEY_001";

  let SURVEY = null;
  let currentQuestionIndex = 0;
  let QUESTION_ID_MAP = {}; // number -> question_uuid (db)
  window.currentResponseId = null;

  const OPTIONS_CACHE = {};

  function isDemographicExternalId(ext) {
    return ext === 'zero_general_curso'
        || ext === 'zero_general_edad'
        || ext === 'zero_general_genero'
        || ext === 'zero_general_tiempo';
  }

  function demographicLabel(ext) {
    if (ext === 'zero_general_curso') return 'Selecciona tu grado';
    if (ext === 'zero_general_edad') return 'Selecciona tu edad';
    if (ext === 'zero_general_genero') return 'Selecciona tu género';
    if (ext === 'zero_general_tiempo') return 'Antigüedad en la escuela';
    return 'Selecciona una opción';
  }

  async function getOptionsForQuestion(questionId) {
    if (!questionId) return [];
    if (OPTIONS_CACHE[questionId]) return OPTIONS_CACHE[questionId];

    const res = await fetch(`/api/question-options?questionId=${encodeURIComponent(questionId)}`, {
      credentials: "include"
    });
    const raw = await res.text();
    let data = {};
    try { data = raw ? JSON.parse(raw) : {}; } catch { data = { raw }; }

    if (!res.ok || !data.ok) {
      throw new Error(`No se pudieron cargar opciones para ${questionId}: ${data.error || data.raw || "sin detalle"}`);
    }

    OPTIONS_CACHE[questionId] = Array.isArray(data.options) ? data.options : [];
    return OPTIONS_CACHE[questionId];
  }

  async function loadSurvey() {
    if (SURVEY) return;
    const res = await fetch('/data/survey_001.json', { cache: 'no-store' });
    if (!res.ok) { alert('No se pudo cargar el survey'); return; }
    SURVEY = await res.json();
  }

  function getDbQuestionIdByNumber(n) {
    return QUESTION_ID_MAP[String(n)] || null;
  }

  function getExternalIdFromSurveyQuestion(q) {
    // en tu JSON nuevo, question_id es el external_id (ej: zero_general_curso)
    return (q && typeof q.question_id === 'string') ? q.question_id : '';
  }

  function renderCurrentQuestion() {
    const question = SURVEY.questions[currentQuestionIndex];
    document.getElementById('qTitle').textContent =
      `Pregunta ${question.number} de ${SURVEY.questions.length}`;
    document.getElementById('qText').textContent = question.text;

    const optionsDiv = document.getElementById('qOptions');
    optionsDiv.innerHTML = '';

    const dbQid = getDbQuestionIdByNumber(question.number);
    const ext = getExternalIdFromSurveyQuestion(question);

    // Si es single_choice: SIEMPRE usamos opciones desde Supabase y guardamos UUID (option_id)
    if (question.type === 'single_choice') {
      if (!dbQid) {
        optionsDiv.innerHTML = `<div class="statusMsg statusErr">No se pudo resolver questionId (DB) para la pregunta #${question.number}.</div>`;
        return;
      }

      // Demográficas: select
      if (isDemographicExternalId(ext)) {
        const label = demographicLabel(ext);
        optionsDiv.innerHTML = `
          <label class="fieldLabel" for="answerSelect">${label}</label><br/>
          <select id="answerSelect" class="textInput">
            <option value="">Cargando...</option>
          </select>
        `;

        (async () => {
          try {
            const opts = await getOptionsForQuestion(dbQid);
            const sel = document.getElementById("answerSelect");
            if (!sel) return;

            sel.innerHTML =
              `<option value="">-- Selecciona --</option>` +
              opts.map(o => {
                const txt = (o.option_text ?? o.option_code ?? "").toString();
                return `<option value="${o.id}">${txt}</option>`;
              }).join("");
          } catch (e) {
            optionsDiv.innerHTML = `<div class="statusMsg statusErr">${e.message || "Error cargando opciones."}</div>`;
          }
        })();

        document.getElementById('btnQPrev').disabled = (currentQuestionIndex === 0);
        document.getElementById('btnQNext').textContent =
          (currentQuestionIndex === SURVEY.questions.length - 1) ? 'Finalizar' : 'Siguiente';
        return;
      }

      // No-demográficas: radios, pero con value=UUID (option_id)
      optionsDiv.innerHTML = `<div class="statusMsg statusWarn">Cargando opciones...</div>`;

      (async () => {
        try {
          const opts = await getOptionsForQuestion(dbQid);
          if (!opts.length) {
            optionsDiv.innerHTML = `<div class="statusMsg statusErr">Esta pregunta no tiene opciones en la base de datos.</div>`;
            return;
          }

          optionsDiv.innerHTML = opts.map(o => {
            const txt = (o.option_text ?? o.option_code ?? "").toString();
            return `
              <label style="display:block; margin-bottom:6px;">
                <input type="radio" name="answer" value="${o.id}">
                ${txt}
              </label>
            `;
          }).join("");
        } catch (e) {
          optionsDiv.innerHTML = `<div class="statusMsg statusErr">${e.message || "Error cargando opciones."}</div>`;
        }
      })();

      document.getElementById('btnQPrev').disabled = (currentQuestionIndex === 0);
      document.getElementById('btnQNext').textContent =
        (currentQuestionIndex === SURVEY.questions.length - 1) ? 'Finalizar' : 'Siguiente';
      return;
    }

    // fallback por si existieran text
    if (question.type === 'text') {
      optionsDiv.innerHTML =
        `<input class="textInput" type="text" id="answerText" placeholder="Escribe tu respuesta" />`;
    }

    document.getElementById('btnQPrev').disabled = (currentQuestionIndex === 0);
    document.getElementById('btnQNext').textContent =
      (currentQuestionIndex === SURVEY.questions.length - 1) ? 'Finalizar' : 'Siguiente';
  }

  async function saveCurrentAnswerOrStop() {
    const q = SURVEY?.questions?.[currentQuestionIndex];
    if (!q) { alert('No hay pregunta actual'); return false; }

    const responseId = window.currentResponseId;
    if (!responseId) { alert('Falta responseId (inicia sesión y vuelve a intentar).'); return false; }

    const questionId = getDbQuestionIdByNumber(q.number);
    if (!questionId) { alert('No se pudo resolver questionId para number: ' + q.number); return false; }

    let answerText = null;
    let selectedOptionIds = [];

    if (q.type === 'single_choice') {
      const ext = getExternalIdFromSurveyQuestion(q);

      if (isDemographicExternalId(ext)) {
        const v = document.getElementById('answerSelect')?.value || "";
        if (v) selectedOptionIds = [v]; // UUID de option
      } else {
        const checked = document.querySelector('input[name="answer"]:checked');
        if (checked) selectedOptionIds = [checked.value]; // UUID de option
      }
    } else if (q.type === 'text') {
      answerText = document.getElementById('answerText')?.value?.trim() || null;
    }

    // required por defecto: true si no existe en JSON
    const required = (q.required === undefined) ? true : !!q.required;

    if (required) {
      if (q.type === 'text') {
        if (!answerText) { alert('Escribe una respuesta para continuar.'); return false; }
      } else {
        if (selectedOptionIds.length === 0) { alert('Selecciona una opción para continuar.'); return false; }
      }
    }

    const payload = { responseId, questionId, answerText, selectedOptionIds };

    const r = await fetch('/api/save-answer', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const raw = await r.text();
    let j = {};
    try { j = raw ? JSON.parse(raw) : {}; } catch { j = { raw }; }

    if (!r.ok || !j.ok) {
      alert('No se pudo guardar (HTTP ' + r.status + '):\n' + JSON.stringify(j, null, 2));
      return false;
    }
    return true;
  }

  async function showSurveyUI() {
    if (btnIngresarEncuesta) btnIngresarEncuesta.disabled = true;
    if (btnSolicitarAnalisis) btnSolicitarAnalisis.disabled = true;

    if (encuestaOK) {
      encuestaOK.style.pointerEvents = 'none';
      encuestaOK.style.opacity = '0.6';
    }

    await loadSurvey();

    const r = await fetch(`/api/questions-map?surveyId=${encodeURIComponent(SURVEY_UUID)}`, {
      credentials: 'include'
    });

    const raw = await r.text();
    let data = {};
    try { data = raw ? JSON.parse(raw) : {}; } catch { data = { raw }; }

    if (!r.ok || !data.ok) {
      alert('No se pudo cargar mapa de preguntas: ' + (data.error || data.raw || 'sin detalle'));
      return;
    }

    QUESTION_ID_MAP = data.map || {};

    if (!window.currentResponseId) {
      const r2 = await fetch('/api/start-response', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ surveyId: SURVEY_CODE })
      });

      const raw2 = await r2.text();
      let j2 = {};
      try { j2 = raw2 ? JSON.parse(raw2) : {}; } catch { j2 = { raw2 }; }

      if (!r2.ok || !j2.ok) {
        alert('No se pudo iniciar la encuesta (HTTP ' + r2.status + '):\n' + JSON.stringify(j2, null, 2));
        return;
      }

      window.currentResponseId = j2.responseId;
    }

    surveyBox.style.display = 'block';
    currentQuestionIndex = 0;
    renderCurrentQuestion();
  }

  document.getElementById('btnQPrev')?.addEventListener('click', () => {
    if (!SURVEY) return;
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      renderCurrentQuestion();
    }
  });

  document.getElementById('btnQNext')?.addEventListener('click', async () => {
    const ok = await saveCurrentAnswerOrStop();
    if (!ok) return;

    if (currentQuestionIndex < SURVEY.questions.length - 1) {
      currentQuestionIndex++;
      renderCurrentQuestion();
      return;
    }

    try {
      const r3 = await fetch('/api/submit-response', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ responseId: window.currentResponseId })
      });

      const raw3 = await r3.text();
      let j3 = {};
      try { j3 = raw3 ? JSON.parse(raw3) : {}; } catch { j3 = { raw3 }; }

      if (!r3.ok || !j3.ok) {
        alert('No se pudo finalizar la encuesta (HTTP ' + r3.status + '):\n' + JSON.stringify(j3, null, 2));
        return;
      }
    } catch (e) {
      alert('Error de conexión al finalizar la encuesta.');
      return;
    }

    if (surveyBox) surveyBox.style.display = 'none';

    window.currentResponseId = null;
    SURVEY = null;
    QUESTION_ID_MAP = {};
    currentQuestionIndex = 0;

    applySessionToUI();
    alert('Encuesta finalizada.');
  });

  // Inicial
  refreshSession();

  // =========================
  // CONTACTO: enviar email vía /api/contact (Resend)
  // =========================
  const cNombre = document.getElementById('c_nombre');
  const cEmail  = document.getElementById('c_email');
  const cAsunto = document.getElementById('c_asunto');
  const cMensaje= document.getElementById('c_mensaje');
  const cCompany= document.getElementById('c_company'); // honeypot
  const btnEnviarContacto = document.getElementById('btnEnviarContacto');
  const btnLimpiarContacto = document.getElementById('btnLimpiarContacto');
  const contactoMsg = document.getElementById('contactoMsg');

  function setContactoMsg(text, type) {
    if (!contactoMsg) return;
    contactoMsg.textContent = text || '';
    contactoMsg.classList.remove('statusOk', 'statusWarn', 'statusErr');
    contactoMsg.classList.add(type || 'statusWarn');
  }

  btnLimpiarContacto?.addEventListener('click', () => {
    if (cNombre) cNombre.value = '';
    if (cEmail) cEmail.value = '';
    if (cAsunto) cAsunto.value = '';
    if (cMensaje) cMensaje.value = '';
    if (cCompany) cCompany.value = '';
    setContactoMsg('', 'statusWarn');
  });

  btnEnviarContacto?.addEventListener('click', async () => {
    const name = cNombre?.value?.trim() || '';
    const email = cEmail?.value?.trim() || '';
    const subject = cAsunto?.value?.trim() || '';
    const message = cMensaje?.value?.trim() || '';
    const hp = cCompany?.value?.trim() || ''; // honeypot

    if (!name || !email || !subject || !message) {
      setContactoMsg('Por favor completa nombre, email, asunto y mensaje.', 'statusWarn');
      return;
    }

    // Validación simple de email
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      setContactoMsg('Email inválido. Revisa el formato.', 'statusWarn');
      return;
    }

    try {
      btnEnviarContacto.disabled = true;
      setContactoMsg('Enviando...', 'statusWarn');

      const res = await fetch('/api/contact', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email, subject, message, hp })
      });

      const raw = await res.text();
      let data = {};
      try { data = raw ? JSON.parse(raw) : {}; } catch { data = { raw }; }

      if (!res.ok || !data.ok) {
        setContactoMsg(`No se pudo enviar (HTTP ${res.status}): ${data.error || data.raw || 'sin detalle'}`, 'statusErr');
        return;
      }

      setContactoMsg('Mensaje enviado. ¡Gracias!', 'statusOk');
      btnLimpiarContacto?.click();
    } catch (e) {
      setContactoMsg('Error de conexión al enviar el mensaje.', 'statusErr');
    } finally {
      btnEnviarContacto.disabled = false;
    }
  });


  
</script>

</body>
</html>









































