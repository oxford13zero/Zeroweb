<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>TECH4ZERO – Educational Designs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    body { margin:0; font-family:'Open Sans', Arial, sans-serif; background-color:#1E2F3F; color:#ffffff; }

    header { padding:40px 20px; text-align:center; background:linear-gradient(180deg, #1E2F3F, #16222D); }
    header h1 { font-family:'Playfair Display', serif; font-size:48px; margin:0; }
    header p { color:#D6A21C; letter-spacing:2px; margin-top:10px; font-size:14px; }

    nav { display:flex; justify-content:center; gap:15px; padding:15px; background-color:#16222D; flex-wrap:wrap; }
    nav a { background-color:#1E2F3F; color:white; padding:8px 18px; border-radius:20px; text-decoration:none; font-size:14px; font-weight:600; }
    nav a:hover { background-color:#D6A21C; color:#16222D; }

    section { display:none; padding:50px 20px; max-width:1000px; margin:auto; }
    section.active { display:block; }

    h2 { font-family:'Playfair Display', serif; color:#D6A21C; font-size:32px; margin-top:0; }

    .card { background-color:#243A4B; padding:25px; border-radius:8px; margin-top:25px; }

    footer { text-align:center; padding:30px; font-size:13px; background-color:#16222D; margin-top:50px; }

    /* Buttons */
    .btnPrimary { padding:10px 16px; font-weight:700; border-radius:6px; border:none; cursor:pointer; }
    .btnSecondary { padding:10px 16px; font-weight:600; border-radius:6px; border:1px solid #D6A21C; background:transparent; color:#D6A21C; cursor:pointer; }

    /* Compact panel + stacked inputs */
    .formPanel {
      margin-top: 18px;
      background: #1E2F3F;
      padding: 16px;
      border-radius: 8px;
      max-width: 520px;
      border: 1px solid #365468;
    }
    .fieldBlock { margin-bottom: 14px; }
    .fieldLabel { font-weight:600; display:inline-block; margin-bottom:6px; }
    .textInput {
      width:100%;
      max-width:380px;
      padding:8px;
      border-radius:6px;
      border:1px solid #365468;
      background:#0f1d27;
      color:#ffffff;
      outline:none;
    }
    .textInput::placeholder { color:#a9c0d3; }

    .statusMsg { margin-top:12px; font-weight:600; min-height:18px; }
    .statusOk { color:#b9ffcf; }
    .statusWarn { color:#ffdca8; }
    .statusErr { color:#ffb4b4; }
  </style>

  <script>
    function showTab(tabId) {
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      if (tabId === 'datos') window.loadDatosIfNeeded?.();
    }

    
  </script>
</head>

<body>

<header>
  <h1>TECH4ZERO</h1>
  <p>EDUCATION+IA</p>
</header>

<nav>
  <a href="#" onclick="showTab('home'); return false;">INICIO</a>
  <a href="#" onclick="showTab('programa'); return false;">PROGRAMA</a>
  <a href="#" onclick="showTab('encuesta'); return false;">ENCUESTA</a>
  <a href="#" onclick="showTab('datos'); return false;">DATOS</a>
  <a href="#" onclick="showTab('resultados'); return false;">RESULTADOS</a>
  <a href="#" onclick="showTab('equipo'); return false;">EQUIPO</a>
  <a href="#" onclick="showTab('contacto'); return false;">CONTACTO</a>
</nav>

<section id="home" class="active">
  <h2>Bienvenidos</h2>

  <div class="card">
    <p>
      TECH4ZERO desarrolla programas educativos basados en experiencia,
      cooperación, lenguaje y emociones, con foco en la prevención del bullying.
    </p>
  </div>

  <div class="card" style="margin-top:30px; text-align:center;">
    <iframe width="560" height="315"
      src="https://www.youtube.com/embed/iBO4YijRYbs"
      title="Programa ZERO"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen>
    </iframe>
  </div>

  <div style="margin-top:30px; text-align:center;">
    <img src="zero.png" alt="Logo ZERO" style="max-width:220px;" />
  </div>
</section>

<section id="programa">
  <h2>Programa Antibullying TECH4ZERO</h2>
  <div class="card">
    <p>
      Programa antibullying internacional, implementado en escuelas de Estados Unidos
      y Latinoamérica, con resultados comprobados.
    </p>
  </div>
</section>

<section id="encuesta">
  <h2>Encuesta Escolar</h2>
  <div class="card">
    <p>
      Para ingresar a la encuesta, deberá introducir su <b>usuario</b> y <b>contraseña</b>.
    </p>
    <!-- Intro -->
    <div id="encuestaIntro" style="margin-top:14px;">
      <button id="btnMostrarLogin" class="btnPrimary" type="button">Ingresar a la encuesta</button>
    </div>
    <!-- Login Panel -->
    <div id="loginPanel" class="formPanel" style="display:none;">
      <div class="fieldBlock">
        <label for="loginUser" class="fieldLabel">Usuario</label><br />
        <input id="loginUser" class="textInput" type="text" placeholder="Usuario" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false" />
      </div>
      <div class="fieldBlock">
        <label for="loginPass" class="fieldLabel">Contraseña</label><br />
        <input id="loginPass" class="textInput" type="password" placeholder="Contraseña" autocomplete="new-password" />
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="btnLogin" class="btnPrimary" type="button">Entrar</button>
        <button id="btnCancelarLogin" class="btnSecondary" type="button">Cancelar</button>
      </div>
      <div id="loginMsg" class="statusMsg statusErr"></div>
    </div>
    <!-- Survey Box -->
    <div id="surveyBox" class="formPanel" style="display:none; margin-top:18px;">
      <div id="qTitle" style="font-weight:700; margin-bottom:10px;"></div>
      <div id="qText" style="margin-bottom:12px;"></div>
      <div id="qOptions"></div>

      <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
        <button id="btnQPrev" class="btnSecondary" type="button">Anterior</button>
        <button id="btnQNext" class="btnPrimary" type="button">Siguiente</button>
      </div>
      <!-- 
      ===== DEBUG GUARDADO (TEMP) =====  
      <div style="margin-top:12px; padding:10px; border:1px solid #365468; border-radius:8px;">
        <div style="font-weight:700; margin-bottom:6px;">Debug guardado</div>
        <div><b>build:</b> <span id="dbgBuild">INDEX_BUILD_2025_12_14_A</span></div>
        <div><b>responseId:</b> <span id="dbgResponseId">(vacío)</span></div>
        <div><b>questionCode:</b> <span id="dbgQuestionCode">(vacío)</span></div>
        <div><b>questionId:</b> <span id="dbgQuestionId">(vacío)</span></div>
        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
         <button id="btnStartDebug" class="btnSecondary" type="button" style="display:none;">1) Crear response</button>
          <button id="btnSaveDebug" class="btnPrimary" type="button">2) Guardar respuesta</button>
        </div>
      </div>
      <!--  ===== FIN DEBUG ===== 
      -->
      <div id="surveyMsg" class="statusMsg statusWarn"></div>
    </div>
    <!-- OK Panel -->
    <div id="encuestaOK" class="formPanel" style="display:none; opacity:0.75; max-width:420px;">
      <p id="schoolWelcome" style="margin:0 0 12px 0;">Acceso concedido.</p>
      <button id="btnLogout" class="btnSecondary" type="button" style="font-size:13px; padding:6px 12px;">Cerrar sesión</button>
    </div>
  </div>
</section>

<section id="resultados">
  <h2>Resultados Encuesta</h2>

  <div class="card">
    <p>
      Para ver los resultados, deberá introducir su <b>usuario</b> y <b>contraseña</b>.
    </p>

    <!-- Intro -->
    <div id="resultadosIntro" style="margin-top:14px;">
      <button id="btnMostrarLoginResultados" class="btnPrimary" type="button">
        Mostrar resultados encuesta
      </button>
    </div>

    <!-- Login Panel (Resultados) -->
    <div id="loginPanelResultados" class="formPanel" style="display:none;">
      <div class="fieldBlock">
        <label for="loginUserResultados" class="fieldLabel">Usuario</label><br />
        <input id="loginUserResultados" class="textInput" type="text"
               placeholder="Usuario" autocomplete="off" autocapitalize="none"
               autocorrect="off" spellcheck="false" />
      </div>

      <div class="fieldBlock">
        <label for="loginPassResultados" class="fieldLabel">Contraseña</label><br />
        <input id="loginPassResultados" class="textInput" type="password"
               placeholder="Contraseña" autocomplete="new-password" />
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="btnLoginResultados" class="btnPrimary" type="button">Entrar</button>
        <button id="btnCancelarLoginResultados" class="btnSecondary" type="button">Cancelar</button>
      </div>

      <div id="loginMsgResultados" class="statusMsg statusErr"></div>
    </div>

    <!-- OK Panel (Resultados) -->
    <div id="resultadosOK" class="formPanel" style="display:none; opacity:0.75; max-width:420px;">
      <p id="schoolWelcomeResultados" style="margin:0 0 12px 0;">Acceso concedido.</p>
      <button id="btnLogoutResultados" class="btnSecondary" type="button"
              style="font-size:13px; padding:6px 12px;">
        Cerrar sesión
      </button>
    </div>

    <!-- Contenedor futuro para mostrar resultados -->
    <div id="resultadosBox" class="formPanel" style="display:none; margin-top:18px;">
      <div id="resultadosMsg" class="statusMsg statusWarn">
        (Próximo paso: aquí mostraremos los resultados.)
      </div>
    </div>

  </div>
</section>



  
<section id="datos">
  <h2>Datos</h2>

  <div class="card">
    <p>
      Esta sección lee datos desde Supabase (tabla <b>encargado_escolar</b>) para verificar conexión.
    </p>

    <div class="formPanel">
      <div class="fieldBlock">
        <label class="fieldLabel" for="d_nombre">Nombre</label><br />
        <input id="d_nombre" class="textInput" type="text" placeholder="Nombre" readonly />
      </div>

      <div class="fieldBlock">
        <label class="fieldLabel" for="d_ap_paterno">Apellido Paterno</label><br />
        <input id="d_ap_paterno" class="textInput" type="text" placeholder="Apellido Paterno" readonly />
      </div>

      <div class="fieldBlock">
        <label class="fieldLabel" for="d_ap_materno">Apellido Materno</label><br />
        <input id="d_ap_materno" class="textInput" type="text" placeholder="Apellido Materno" readonly />
      </div>

      <div class="fieldBlock">
        <label class="fieldLabel" for="d_establecimiento">Establecimiento</label><br />
        <input id="d_establecimiento" class="textInput" type="text" placeholder="Establecimiento" readonly />
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;">
        <button id="btnPrev" class="btnSecondary" type="button">Retroceder</button>
        <button id="btnNext" class="btnPrimary" type="button">Avanzar</button>
      </div>

      <div id="datosStatus" class="statusMsg statusWarn"></div>
    </div>
  </div>
</section>

<section id="equipo">
  <h2>Nuestro Equipo</h2>
  <div class="card">
    <p>
      Equipo interdisciplinario de especialistas en educación, psicología y tecnología
      comprometidos con comunidades escolares seguras.
    </p>
  </div>
</section>

<section id="contacto">
  <h2>Contáctenos</h2>
  <div class="card">
    <p>Email: contacto@tech4zero.org</p>
  </div>
</section>

<footer>
  © 2025 TECH4ZERO – Educational Designs
</footer>

<script>
  // === DEBUG: mostrar errores JS sin consola ===
  window.onerror = function (msg, src, line, col) {
    alert(`JS ERROR: ${msg}\n${src}:${line}:${col}`);
    const el = document.getElementById('loginMsg');
    if (el) el.textContent = `JS ERROR: ${msg}`;
  };
  window.onunhandledrejection = function (e) {
  const reason = e?.reason;
  const msg =
    (reason && (reason.message || String(reason))) ||
    'Unhandled promise rejection';

  const stack = reason?.stack ? ("\n\nSTACK:\n" + reason.stack) : "";
  alert('PROMISE ERROR: ' + msg + stack);

  const el = document.getElementById('loginMsg');
  if (el) el.textContent = `PROMISE ERROR: ${msg}`;
};


  /* -------------------------
     LOGIN (BACKEND /api/login + /api/logout)
  -------------------------- */
  const btnMostrarLogin = document.getElementById('btnMostrarLogin');
  const loginPanel = document.getElementById('loginPanel');
  const btnCancelarLogin = document.getElementById('btnCancelarLogin');
  const btnLogin = document.getElementById('btnLogin');
  const loginMsg = document.getElementById('loginMsg');

  const encuestaIntro = document.getElementById('encuestaIntro');
  const encuestaOK = document.getElementById('encuestaOK');
  const schoolWelcome = document.getElementById('schoolWelcome');
  const btnLogout = document.getElementById('btnLogout');

  const surveyBox = document.getElementById('surveyBox');

  btnMostrarLogin.addEventListener('click', async () => {
    loginMsg.textContent = '';

    // 1) Verificar si ya existe una sesión válida en backend
    try {
      const res = await fetch('/api/me', { credentials: 'include' });
      const data = await res.json().catch(() => ({}));

      if (data && data.ok) {
        encuestaIntro.style.display = 'none';
        encuestaOK.style.display = 'block';
        schoolWelcome.textContent = `Acceso concedido. Escuela: ${data.school_name}`;
        await showSurveyUI();
        return;
      }
    } catch (e) {
      // si falla, seguimos al login normal
    }

    // 2) Si no hay sesión, mostrar formulario de login
    loginPanel.style.display = 'block';
    btnMostrarLogin.style.display = 'none';
    document.getElementById('loginUser').focus();
  });

  btnCancelarLogin.addEventListener('click', () => {
    loginMsg.textContent = '';
    loginPanel.style.display = 'none';
    btnMostrarLogin.style.display = 'inline-block';
    document.getElementById('loginUser').value = '';
    document.getElementById('loginPass').value = '';
  });

  btnLogin.addEventListener('click', async () => {
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value.trim();

    if (!u || !p) {
      loginMsg.textContent = 'Por favor ingrese usuario y contraseña.';
      return;
    }

    try {
      loginMsg.textContent = 'Validando...';

      const res = await fetch('/api/login', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: u, password: p })
      });

      const raw = await res.text();
      let data = {};
      try { data = raw ? JSON.parse(raw) : {}; } catch { data = { raw }; }

      if (!res.ok || !data.ok) {
        loginMsg.textContent = `Login falló (HTTP ${res.status}): ${data.error || data.raw || 'sin detalle'}`;
        return;
      }

      // Login OK
      loginMsg.textContent = '';
      loginPanel.style.display = 'none';
      encuestaIntro.style.display = 'none';
      encuestaOK.style.display = 'block';
      schoolWelcome.textContent = `Acceso concedido. Escuela: ${data.school_name}`;
      await showSurveyUI();
    } catch (e) {
      loginMsg.textContent = 'Error de conexión.';
    }
  });

  btnLogout.addEventListener('click', async () => {
    await fetch('/api/logout', { method: 'POST', credentials: 'include' }).catch(() => {});
    // reset UI
    encuestaOK.style.display = 'none';
    encuestaIntro.style.display = 'block';
    btnMostrarLogin.style.display = 'inline-block';
    loginPanel.style.display = 'none';
    loginMsg.textContent = '';
    document.getElementById('loginUser').value = '';
    document.getElementById('loginPass').value = '';
    surveyBox.style.display = 'none';
  });

  /* -------------------------
     DATOS: Supabase REST read
  -------------------------- */
  const SUPABASE_URL = "https://dthynoikkbmgulbrueya.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR0aHlub2lra2JtZ3VsYnJ1ZXlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2ODIzMDgsImV4cCI6MjA4MTI1ODMwOH0.k-jdaJ-QOu9RCTWIJ2vTZ1Eefdby70asQIq9rdTmPT4";

  let datosIndex = 0;
  let datosLoadedOnce = false;

  const elNombre = document.getElementById('d_nombre');
  const elApPaterno = document.getElementById('d_ap_paterno');
  const elApMaterno = document.getElementById('d_ap_materno');
  const elEst = document.getElementById('d_establecimiento');
  const elStatus = document.getElementById('datosStatus');

  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');

  function setStatus(text, type) {
    elStatus.textContent = text || '';
    elStatus.classList.remove('statusOk', 'statusWarn', 'statusErr');
    elStatus.classList.add(type || 'statusWarn');
  }

  function fillFields(row) {
    elNombre.value = row?.first_name ?? '';
    elApPaterno.value = row?.pat_last_name ?? '';
    elApMaterno.value = row?.mat_last_name ?? '';
    elEst.value = row?.school_id ?? '';
  }

  async function fetchOneRow(offset) {
    const url =
      `${SUPABASE_URL}/rest/v1/encargado_escolar` +
      `?select=first_name,pat_last_name,mat_last_name,school_id` +
      `&limit=1&offset=${offset}`;

    const res = await fetch(url, {
      headers: {
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": "Bearer " + SUPABASE_ANON_KEY,
        "Accept": "application/json"
      }
    });

    const text = await res.text();
    let json;
    try { json = text ? JSON.parse(text) : null; } catch { json = null; }

    return { ok: res.ok, status: res.status, json };
  }

  async function loadCurrent() {
    setStatus("Cargando datos...", "statusWarn");

    try {
      const result = await fetchOneRow(datosIndex);

      if (!result.ok) {
        setStatus(` No se pudo leer encargado_escolar (HTTP ${result.status ?? "?"}).`, "statusErr");
        fillFields(null);
        return;
      }

      const arr = Array.isArray(result.json) ? result.json : [];
      if (arr.length === 0) {
        if (datosIndex === 0) {
          setStatus(" La tabla encargado_escolar está vacía (no hay registros).", "statusWarn");
        } else {
          setStatus(" No hay más registros. Retrocede para ver anteriores.", "statusWarn");
          datosIndex = Math.max(0, datosIndex - 1);
        }
        fillFields(null);
        return;
      }

      fillFields(arr[0]);
      setStatus(` Mostrando registro #${datosIndex + 1}`, "statusOk");
    } catch (e) {
      setStatus(" Error de conexión con Supabase.", "statusErr");
      fillFields(null);
    }
  }

  btnPrev.addEventListener('click', async () => {
    datosIndex = Math.max(0, datosIndex - 1);
    await loadCurrent();
  });

  btnNext.addEventListener('click', async () => {
    datosIndex = datosIndex + 1;
    await loadCurrent();
  });

  window.loadDatosIfNeeded = async () => {
    if (datosLoadedOnce) return;
    datosLoadedOnce = true;
    datosIndex = 0;
    await loadCurrent();
  };

  /* ================================
     ENCUESTA
  ================================ */

  // IMPORTANTE: tu survey en BD tiene id:
  const SURVEY_UUID = "d43cddec-0693-4d03-a6f4-31b73e44b31f";
  // y tu start-response acepta code "SURVEY_001"
  const SURVEY_CODE = "SURVEY_001";

  let SURVEY = null;
  let currentQuestionIndex = 0;
  let QUESTION_ID_MAP = {};
  window.currentResponseId = null;

  // === PREGUNTAS ESPECIALES (combobox) ===
  const QID_EDAD  = "1b5f4f28-8f41-4ed7-9bfa-07d927b2d1b4";
  const QID_GRADO = "6b5b3cdd-5e6d-4c02-a6c4-63d7b3c52e30";
  const QID_GENERO= "c0a89b93-2b39-4e4c-9f10-8f58dbf8d0c7";

  function getCurrentQuestionId(questionNumber) {
    return QUESTION_ID_MAP[String(questionNumber)] || null;
  }
  function isEdadQ(qid)   { return qid === QID_EDAD; }
  function isGradoQ(qid)  { return qid === QID_GRADO; }
  function isGeneroQ(qid) { return qid === QID_GENERO; }

  
  
  function dbgRender() {
  return; // debug deshabilitado
}





  
  async function loadSurvey() {
    if (SURVEY) return;
    const res = await fetch('/data/survey_001.json', { cache: 'no-store' });
    if (!res.ok) {
      alert('No se pudo cargar el survey');
      return;
    }
    SURVEY = await res.json();
  }



  
  function renderCurrentQuestion() {
    const question = SURVEY.questions[currentQuestionIndex];
    document.getElementById('qTitle').textContent =
      `Pregunta ${question.number} de ${SURVEY.questions.length}`;
    document.getElementById('qText').textContent = question.text;

    const optionsDiv = document.getElementById('qOptions');
    optionsDiv.innerHTML = '';

    // Resolver questionId real (UUID en tabla questions)
    const qid = getCurrentQuestionId(question.number);

    // === SOLO estas 3 preguntas: combobox ===
    if (qid && (isEdadQ(qid) || isGradoQ(qid) || isGeneroQ(qid))) {

      if (isEdadQ(qid)) {
        let html = `<label class="fieldLabel" for="answerSelect">Selecciona tu edad</label><br/>`;
        html += `<select id="answerSelect" class="textInput">
                  <option value="">-- Selecciona --</option>`;
        for (let i = 6; i <= 20; i++) {
          html += `<option value="${i}">${i}</option>`;
        }
        html += `</select>`;
        optionsDiv.innerHTML = html;

      } else if (isGradoQ(qid)) {
        let html = `<label class="fieldLabel" for="answerSelect">Selecciona tu grado</label><br/>`;
        html += `<select id="answerSelect" class="textInput">
                  <option value="">-- Selecciona --</option>`;
        for (let i = 1; i <= 13; i++) {
          html += `<option value="${i}">${i}</option>`;
        }
        html += `</select>`;
        optionsDiv.innerHTML = html;

      } else if (isGeneroQ(qid)) {
        optionsDiv.innerHTML = `
          <label class="fieldLabel" for="answerSelect">Selecciona tu género</label><br/>
          <select id="answerSelect" class="textInput">
            <option value="">-- Selecciona --</option>
            <option value="M">Masculino</option>
            <option value="F">Femenino</option>
            <option value="O">Otro</option>
            <option value="N">No quiero responder</option>
          </select>
        `;
      }

    } else if (question.type === 'text') {
      optionsDiv.innerHTML =
        `<input class="textInput" type="text" id="answerText" placeholder="Escribe tu respuesta" />`;
    } else {
      question.options.forEach(opt => {
        optionsDiv.insertAdjacentHTML(
          'beforeend',
          `<label style="display:block; margin-bottom:6px;">
             <input type="radio" name="answer" value="${opt.code}">
             ${opt.text}
           </label>`
        );
      });
    }

    document.getElementById('btnQPrev').disabled = (currentQuestionIndex === 0);
    document.getElementById('btnQNext').textContent =
      (currentQuestionIndex === SURVEY.questions.length - 1)
        ? 'Finalizar'
        : 'Siguiente';
    dbgRender();
  }

async function saveCurrentAnswerOrStop() {
  const q = SURVEY?.questions?.[currentQuestionIndex];
  if (!q) { alert('No hay pregunta actual'); return false; }
  const responseId = window.currentResponseId;
  if (!responseId) { alert('Primero debes hacer: 1) Crear response'); return false; }
  const questionId = QUESTION_ID_MAP[String(q.number)] || null;
  if (!questionId) { alert('No se pudo resolver questionId para number: ' + q.number); return false; }
  let answerText = null;
  let selectedOptionCodes = [];

  // === ESPECIALES: combobox (guardar como opción) ===
  if (questionId && (isEdadQ(questionId) || isGradoQ(questionId) || isGeneroQ(questionId))) {
    const v = document.getElementById('answerSelect')?.value || "";
    if (v) selectedOptionCodes = [v];
    answerText = null; // NO guardar texto
  }
  else if (q.type === 'text') {
    answerText = document.getElementById('answerText')?.value?.trim() || null;
  } else {
    const checked = document.querySelector('input[name="answer"]:checked');
    if (checked) selectedOptionCodes = [checked.value];
  }

  // (opcional simple) si es requerida, no avanzar sin respuesta
  if (q.required && ((q.type !== 'text' && selectedOptionCodes.length === 0) || ((questionId && (isEdadQ(questionId) || isGradoQ(questionId) || isGeneroQ(questionId))) && selectedOptionCodes.length === 0))) {
    alert('Selecciona una opción para continuar.');
    return false;
  }

  const payload = {
    responseId,
    questionId,
    answerText,
    selectedOptionIds: selectedOptionCodes
  };
  const r = await fetch('/api/save-answer', {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const raw = await r.text();
  let j = {};
  try { j = raw ? JSON.parse(raw) : {}; } catch { j = { raw }; }
  if (!r.ok || !j.ok) {
    alert('No se pudo guardar (HTTP ' + r.status + '):\n' + JSON.stringify(j, null, 2));
    return false;
  }
  return true;
}

function resetEncuestaUI() {
  // reset survey state
  SURVEY = null;
  currentQuestionIndex = 0;
  QUESTION_ID_MAP = {};
  window.currentResponseId = null;

  // ocultar UI encuesta
  const surveyBox = document.getElementById('surveyBox');
  if (surveyBox) surveyBox.style.display = 'none';

  // limpiar mensaje final
  const m = document.getElementById('surveyMsg');
  if (m) m.textContent = '';

  // volver al estado inicial (botón ingresar)
  const encuestaOK = document.getElementById('encuestaOK');
  const encuestaIntro = document.getElementById('encuestaIntro');
  const btnMostrarLogin = document.getElementById('btnMostrarLogin');
  const loginPanel = document.getElementById('loginPanel');
  const loginMsg = document.getElementById('loginMsg');

  if (encuestaOK) encuestaOK.style.display = 'none';
  if (loginPanel) loginPanel.style.display = 'none';
  if (loginMsg) loginMsg.textContent = '';

  if (encuestaIntro) encuestaIntro.style.display = 'block';
  if (btnMostrarLogin) btnMostrarLogin.style.display = 'inline-block';
}

  
  
  async function showSurveyUI() {
    await loadSurvey();

    // cargar mapa questionCode -> questionUUID (desde backend)
    const r = await fetch(`/api/questions-map?surveyId=${encodeURIComponent(SURVEY_UUID)}`, {
      credentials: 'include'
    });

    const raw = await r.text();
    let data = {};
    try { data = raw ? JSON.parse(raw) : {}; } catch { data = { raw }; }

    if (!r.ok || !data.ok) {
      alert('No se pudo cargar mapa de preguntas: ' + (data.error || data.raw || 'sin detalle'));
      return;
    }

    QUESTION_ID_MAP = data.map || {};


// Crear response automáticamente si no existe
if (!window.currentResponseId) {
  const r2 = await fetch('/api/start-response', {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ surveyId: 'SURVEY_001' })
  });

  const raw2 = await r2.text();
  let j2 = {};
  try { j2 = raw2 ? JSON.parse(raw2) : {}; } catch { j2 = { raw2 }; }

  if (!r2.ok || !j2.ok) {
    alert(
      'No se pudo iniciar la encuesta (HTTP ' +
      r2.status +
      '):\n' +
      JSON.stringify(j2, null, 2)
    );
    return;
  }

  window.currentResponseId = j2.responseId;
}

    // ===== UI: preguntas arriba + panel acceso discreto =====
try {
  // 1) mover surveyBox arriba de encuestaOK (aunque el HTML esté abajo)
  if (encuestaOK && surveyBox && encuestaOK.parentNode) {
    encuestaOK.parentNode.insertBefore(surveyBox, encuestaOK);
  }

  // 2) hacer el panel "Acceso concedido" discreto
  if (encuestaOK) {
    encuestaOK.style.opacity = '0.75';
    encuestaOK.style.maxWidth = '420px';
  }

  // 3) botón salir menos llamativo
  if (btnLogout) {
    btnLogout.textContent = 'Cerrar sesión';
    btnLogout.style.fontSize = '13px';
    btnLogout.style.padding = '6px 12px';
  }
} catch (e) {}

    surveyBox.style.display = 'block';

    
    currentQuestionIndex = 0;
    renderCurrentQuestion();
  }

  document.getElementById('btnQPrev').addEventListener('click', () => {
    if (!SURVEY) return;
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      renderCurrentQuestion();
    }
  });

  
document.getElementById('btnQNext').addEventListener('click', async () => {
  const ok = await saveCurrentAnswerOrStop();
  if (!ok) return;

  if (currentQuestionIndex < SURVEY.questions.length - 1) {
    currentQuestionIndex++;
    renderCurrentQuestion();
    return;
  }

  // ===== ÚLTIMA PREGUNTA: volver al estado inicial =====
  const m = document.getElementById('surveyMsg');
  if (m) m.textContent = '';

  const surveyBox = document.getElementById('surveyBox');
  if (surveyBox) surveyBox.style.display = 'none';

  const encuestaOK = document.getElementById('encuestaOK');
  if (encuestaOK) encuestaOK.style.display = 'none';

  const loginPanel = document.getElementById('loginPanel');
  if (loginPanel) loginPanel.style.display = 'none';

  const encuestaIntro = document.getElementById('encuestaIntro');
  if (encuestaIntro) encuestaIntro.style.display = 'block';

  const btnMostrarLogin = document.getElementById('btnMostrarLogin');
  if (btnMostrarLogin) btnMostrarLogin.style.display = 'inline-block';

  // reset variables
  window.currentResponseId = null;
  SURVEY = null;
  QUESTION_ID_MAP = {};
  currentQuestionIndex = 0;

// limpiar usuario y contraseña
const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
if (loginUser) loginUser.value = '';
if (loginPass) loginPass.value = '';

  
  return;
});




/*  
  // DEBUG: crear response
  document.getElementById('btnStartDebug')?.addEventListener('click', async () => {
    const r = await fetch('/api/start-response', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ surveyId: SURVEY_CODE })
    });
    const raw = await r.text();
    let j = {};
    try { j = raw ? JSON.parse(raw) : {}; } catch { j = { raw }; }
    alert('start-response -> HTTP ' + r.status + '\n' + JSON.stringify(j, null, 2));
    window.currentResponseId = j.responseId || null;
    dbgRender();
  });

  // DEBUG: guardar respuesta
 document.getElementById('btnSaveDebug')?.addEventListener('click', async () => {
  const q = SURVEY?.questions?.[currentQuestionIndex];
  if (!q) { alert('No hay pregunta actual'); return; }
  const responseId = window.currentResponseId;
  if (!responseId) { alert('Falta responseId. Primero: 1) Crear response'); return; }
  const questionId = QUESTION_ID_MAP[String(q.number)] || null;
  if (!questionId) { alert('No se pudo resolver questionId para number: ' + q.number); return; }
  let answerText = null;
  let selectedOptionCodes = [];
  if (q.type === 'text') {
    answerText = document.getElementById('answerText')?.value?.trim() || null;
  } else {
    const checked = document.querySelector('input[name="answer"]:checked');
    if (checked) selectedOptionCodes = [checked.value];
  }
  const payload = {
    responseId: responseId,
    questionId: questionId,
    answerText: answerText,
    selectedOptionIds: selectedOptionCodes
  };
  alert('DEBUG payload:\n' + JSON.stringify(payload, null, 2));
  const r = await fetch('/api/save-answer', {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const raw = await r.text();
  let j = {};
  try { j = raw ? JSON.parse(raw) : {}; } catch { j = { raw }; }
  alert('save-answer -> HTTP ' + r.status + '\n' + JSON.stringify(j, null, 2));
});
*/

<script>
  /* -------------------------
     RESULTADOS: Login igual que Encuesta
     (usa /api/me, /api/login, /api/logout)
  -------------------------- */

  const btnMostrarLoginResultados = document.getElementById('btnMostrarLoginResultados');
  const loginPanelResultados = document.getElementById('loginPanelResultados');
  const btnCancelarLoginResultados = document.getElementById('btnCancelarLoginResultados');
  const btnLoginResultados = document.getElementById('btnLoginResultados');
  const loginMsgResultados = document.getElementById('loginMsgResultados');

  const resultadosIntro = document.getElementById('resultadosIntro');
  const resultadosOK = document.getElementById('resultadosOK');
  const schoolWelcomeResultados = document.getElementById('schoolWelcomeResultados');
  const btnLogoutResultados = document.getElementById('btnLogoutResultados');

  const resultadosBox = document.getElementById('resultadosBox');

  async function showResultadosUI() {
    // Por ahora solo muestra un placeholder
    if (resultadosBox) resultadosBox.style.display = 'block';
  }

  btnMostrarLoginResultados.addEventListener('click', async () => {
    if (loginMsgResultados) loginMsgResultados.textContent = '';

    // 1) Verificar si ya existe sesión válida
    try {
      const res = await fetch('/api/results-me', { credentials: 'include' });
      const data = await res.json().catch(() => ({}));

      if (data && data.ok) {
        if (resultadosIntro) resultadosIntro.style.display = 'none';
        if (resultadosOK) resultadosOK.style.display = 'block';
        if (schoolWelcomeResultados) {
          schoolWelcomeResultados.textContent = `Acceso concedido. Escuela: ${data.school_name}`;
        }
        await showResultadosUI();
        return;
      }
    } catch (e) {
      // si falla, seguimos al login normal
    }

    // 2) Si no hay sesión, mostrar login
    if (loginPanelResultados) loginPanelResultados.style.display = 'block';
    if (btnMostrarLoginResultados) btnMostrarLoginResultados.style.display = 'none';
    document.getElementById('loginUserResultados')?.focus();
  });

  btnCancelarLoginResultados.addEventListener('click', () => {
    if (loginMsgResultados) loginMsgResultados.textContent = '';
    if (loginPanelResultados) loginPanelResultados.style.display = 'none';
    if (btnMostrarLoginResultados) btnMostrarLoginResultados.style.display = 'inline-block';
    const u = document.getElementById('loginUserResultados');
    const p = document.getElementById('loginPassResultados');
    if (u) u.value = '';
    if (p) p.value = '';
  });

  btnLoginResultados.addEventListener('click', async () => {
    const u = document.getElementById('loginUserResultados')?.value?.trim();
    const p = document.getElementById('loginPassResultados')?.value?.trim();

    if (!u || !p) {
      if (loginMsgResultados) loginMsgResultados.textContent = 'Por favor ingrese usuario y contraseña.';
      return;
    }

    try {
      if (loginMsgResultados) loginMsgResultados.textContent = 'Validando...';

      const res = await fetch('/api/results-login', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: u, password: p })
      });

      const raw = await res.text();
      let data = {};
      try { data = raw ? JSON.parse(raw) : {}; } catch { data = { raw }; }

      if (!res.ok || !data.ok) {
        if (loginMsgResultados) {
          loginMsgResultados.textContent =
            `Login falló (HTTP ${res.status}): ${data.error || data.raw || 'sin detalle'}`;
        }
        return;
      }

      // Login OK
      if (loginMsgResultados) loginMsgResultados.textContent = '';
      if (loginPanelResultados) loginPanelResultados.style.display = 'none';
      if (resultadosIntro) resultadosIntro.style.display = 'none';
      if (resultadosOK) resultadosOK.style.display = 'block';
      if (schoolWelcomeResultados) {
        schoolWelcomeResultados.textContent = `Acceso concedido. Escuela: ${data.school_name}`;
      }
      await showResultadosUI();

    } catch (e) {
      if (loginMsgResultados) loginMsgResultados.textContent = 'Error de conexión.';
    }
  });

  btnLogoutResultados.addEventListener('click', async () => {
    await fetch('/api/results-logout', { method: 'POST', credentials: 'include' }).catch(() => {});

    if (resultadosOK) resultadosOK.style.display = 'none';
    if (resultadosIntro) resultadosIntro.style.display = 'block';
    if (btnMostrarLoginResultados) btnMostrarLoginResultados.style.display = 'inline-block';
    if (loginPanelResultados) loginPanelResultados.style.display = 'none';
    if (loginMsgResultados) loginMsgResultados.textContent = '';
    if (resultadosBox) resultadosBox.style.display = 'none';

    const u = document.getElementById('loginUserResultados');
    const p = document.getElementById('loginPassResultados');
    if (u) u.value = '';
    if (p) p.value = '';
  });
</script>


  // ==========================
// RESULTADOS (login independiente)
// ==========================
document.addEventListener("DOMContentLoaded", () => {

  const btn = document.getElementById("btnMostrarLoginResultados");
  const intro = document.getElementById("resultadosIntro");
  const loginPanel = document.getElementById("loginPanelResultados");

  const btnCancel = document.getElementById("btnCancelarLoginResultados");
  const btnLogin = document.getElementById("btnLoginResultados");
  const msg = document.getElementById("loginMsgResultados");

  const okPanel = document.getElementById("resultadosOK");
  const welcome = document.getElementById("schoolWelcomeResultados");
  const btnLogout = document.getElementById("btnLogoutResultados");

  const box = document.getElementById("resultadosBox");

  // Si el botón no existe, no hay nada que inicializar
  if (!btn) return;

  async function showResultadosUI() {
    if (box) box.style.display = "block"; // placeholder por ahora
  }

  btn.addEventListener("click", async () => {
    if (msg) msg.textContent = "";

    // 1) intentar ver si hay sesión de resultados
    try {
      const res = await fetch("/api/results-me", { credentials: "include" });
      const data = await res.json().catch(() => ({}));

      if (data && data.ok) {
        if (intro) intro.style.display = "none";
        if (okPanel) okPanel.style.display = "block";
        if (welcome) welcome.textContent = `Acceso concedido. Escuela: ${data.school_name}`;
        await showResultadosUI();
        return;
      }
    } catch (e) {
      // si falla, seguimos a login normal
    }

    // 2) mostrar login
    if (loginPanel) loginPanel.style.display = "block";
    btn.style.display = "none";
    document.getElementById("loginUserResultados")?.focus();
  });

  btnCancel?.addEventListener("click", () => {
    if (msg) msg.textContent = "";
    if (loginPanel) loginPanel.style.display = "none";
    btn.style.display = "inline-block";
    const u = document.getElementById("loginUserResultados");
    const p = document.getElementById("loginPassResultados");
    if (u) u.value = "";
    if (p) p.value = "";
  });

  btnLogin?.addEventListener("click", async () => {
    const u = document.getElementById("loginUserResultados")?.value?.trim();
    const p = document.getElementById("loginPassResultados")?.value?.trim();

    if (!u || !p) {
      if (msg) msg.textContent = "Por favor ingrese usuario y contraseña.";
      return;
    }

    try {
      if (msg) msg.textContent = "Validando...";

      const res = await fetch("/api/results-login", {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: u, password: p })
      });

      const raw = await res.text();
      let data = {};
      try { data = raw ? JSON.parse(raw) : {}; } catch { data = { raw }; }

      if (!res.ok || !data.ok) {
        if (msg) msg.textContent = `Login falló (HTTP ${res.status}): ${data.error || data.raw || "sin detalle"}`;
        return;
      }

      if (msg) msg.textContent = "";
      if (loginPanel) loginPanel.style.display = "none";
      if (intro) intro.style.display = "none";
      if (okPanel) okPanel.style.display = "block";
      if (welcome) welcome.textContent = `Acceso concedido. Escuela: ${data.school_name}`;
      await showResultadosUI();

    } catch (e) {
      if (msg) msg.textContent = "Error de conexión.";
    }
  });

  btnLogout?.addEventListener("click", async () => {
    await fetch("/api/results-logout", { method: "POST", credentials: "include" }).catch(() => {});

    if (okPanel) okPanel.style.display = "none";
    if (intro) intro.style.display = "block";
    btn.style.display = "inline-block";
    if (loginPanel) loginPanel.style.display = "none";
    if (msg) msg.textContent = "";
    if (box) box.style.display = "none";

    const u = document.getElementById("loginUserResultados");
    const p = document.getElementById("loginPassResultados");
    if (u) u.value = "";
    if (p) p.value = "";
  });

});

</script>

</body>
</html>
















